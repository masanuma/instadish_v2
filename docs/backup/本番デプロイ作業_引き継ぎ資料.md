# InstaDish Pro 本番デプロイ作業 引き継ぎ資料

**作成日**: 2024年12月19日  
**作業者**: AI Assistant  
**対象**: 本番デプロイ問題の解決作業

---

## 1. 本日の作業内容

### 1.1 問題の特定
- **Gitリモート設定確認**  
  - 正しく `masanuma/instadish_v2` リポジトリに設定済み

- **作業ブランチ確認**  
  - 元々 `master` ブランチで作業していた
  - 本番Railwayは `main` ブランチのみ監視

- **ファイルのGit管理状況確認**  
  - `src/app/admin/login/page.tsx` など必要ファイルが存在し、Git管理下にあることを確認

### 1.2 解決作業
- **masterブランチの内容をコミット・PUSH**  
  - すべての変更を `master` にコミットし、`origin/master` にPUSH

- **mainブランチの作成・切り替え・マージ**  
  - `main` ブランチをローカルで作成し、`master` の内容を `main` にマージ（履歴の違いも許可）
  - マージコンフリクトは「master優先」で解決し、コミット

- **mainブランチをGitHubにPUSH**  
  - `origin/main` にPUSHし、mainブランチが最新状態であることを確認

- **作業ディレクトリがクリーンな状態であることを確認**  
  - `git status` で「nothing to commit, working tree clean」

---

## 2. 明日以降の作業・確認ポイント

### 2.1 GitHubのmainブランチ確認
- [ ] `https://github.com/masanuma/instadish_v2` の mainブランチに、必要なファイル（例: `src/app/admin/login/page.tsx`）が存在しているか確認

### 2.2 Railwayのデプロイ状況確認
- [ ] Railwayの「Deployments」タブで、mainブランチの最新コミットで自動デプロイが走っているか確認
- [ ] デプロイに失敗していないか、エラーが出ていないか確認

### 2.3 本番環境の動作確認
- [ ] `/admin/login` など、問題となっていたページ・APIが本番で正しく動作するか確認

### 2.4 もし問題があれば
- [ ] エラーメッセージや状況を記録し、再度調査・修正
- [ ] 必要に応じて、`main` ブランチで修正→コミット→PUSH→デプロイ

---

## 3. 注意事項・運用ルール（再掲）

### 3.1 本番運用ルール
- **本番は「instadish_v2」リポジトリの「main」ブランチのみ**
- **masterで作業した場合は、必ずmainにマージしてからPUSH**
- **Gitリモート設定（git remote -v）でPUSH先を常に確認**

### 3.2 環境固有の注意点
- **Windows環境ではディレクトリ名・ファイル名の大文字小文字に注意**
- **どうしても反映されない場合は、GitHubのWeb UIで手動アップロードも有効**

### 3.3 禁止事項
- **v3リポジトリやブランチは絶対に使わない**

---

## 4. トラブル時のチェックリスト

### 4.1 Git関連
- [ ] GitHubのリポジトリ・ブランチが正しいか
- [ ] PUSH後、GitHubの「main」ブランチに最新ファイルが反映されているか
- [ ] ローカルのブランチ名が正しいか（mainブランチで作業しているか）

### 4.2 Railway関連
- [ ] Railwayの「Settings」→「Integrations」で連携先を確認
- [ ] Railwayのデプロイ履歴で「main」ブランチのコミットがトリガーになっているか

### 4.3 アプリケーション関連
- [ ] 本番で404やAPIエラーが出た場合は、ファイル配置・大文字小文字・APIルートの有無を再確認

---

## 5. 次回作業担当者へのメッセージ

- 何か不明点やエラーがあれば、上記の「確認ポイント」を順にチェックしてください。
- 状況を記録し、必要に応じてAIや他のメンバーに相談してください。
- このドキュメントを更新して、新しい問題や解決策を記録してください。

---

## 6. 参考リンク

- **GitHubリポジトリ**: https://github.com/masanuma/instadish_v2
- **Railwayダッシュボード**: Railwayのプロジェクトダッシュボード
- **本番環境**: Railwayでデプロイされた本番URL

---

**更新履歴**:
- 2024/12/19: 初版作成（本番デプロイ問題解決作業の記録）

## 2024年7月2日 作業記録・進捗まとめ（AI Assistant追記）

### 1. 本日できたこと・進捗
- **AI画像処理API（/api/ai-process）本番化・認証強化**
  - OpenAI本番API呼び出し・認証必須化・環境変数の本番用設定を確認。
  - 画像アップロード・AI処理の401エラーは認証トークン送信・検証ロジックの見直しで解消傾向。
- **サブスク・管理画面の本番動作確認**
  - Stripe型エラー修正（apiVersion: 2025-06-30.basil）済み。
  - 管理画面（/admin）で店舗一覧・サブスク状態・統計・管理アクションが動作することを確認。
- **npm依存関係・package.json修正**
  - マージコンフリクト残骸やEJSONPARSEエラーを修正し、`npm run dev`が正常起動することを確認。
- **一般ユーザーのログイン・認証も正常動作**
  - `/api/auth/login`のパスワード認証・セッション生成も問題なし。

### 2. 残タスク・明日以降の課題
- **管理者ログイン（/admin/login）だけが本番で通らない問題**
  - DBのadmin_usersテーブルにはadminユーザーが存在し、is_active=TRUE。
  - パスワードハッシュ（admin123）はbcryptjs(10ラウンド)で生成済み。
  - API側も`bcrypt.compare`で検証しているが、どうしても「ユーザー名またはパスワードが正しくありません」になる。
  - DB接続先・環境変数（SUPABASE_SERVICE_ROLE_KEY等）は正しい。
  - `isValid`をtrueに強制してもログイン不可→ユーザー取得ロジックや他の認証条件も疑う必要あり。
- **本質的な解決案**
  - 本番サーバー自身で「パスワードハッシュ生成・検証」できる一時APIや管理者登録APIを用意し、Node.js＋bcryptjsの実行環境で確実にハッシュ値を生成・検証する。
  - bcryptjsのバージョン・Node.jsのバージョン・OS依存の差異も考慮。
- **Supabaseクライアントの初期化方式の統一**
  - 一般ユーザーAPIは`NEXT_PUBLIC_SUPABASE_ANON_KEY`、admin APIは`SUPABASE_SERVICE_ROLE_KEY`を利用している。環境変数の設定ミスや権限差異も再確認。
- **管理者セッションのJWTトークン生成・検証の本番化**
  - 現状は`dummy-admin-token`で仮実装。本番用のセキュアなトークン発行・検証に切り替える。
- **本番DBのadmin_usersテーブルのハッシュ値を再度確認**
  - ローカルで生成したハッシュ値と本番DBの値が一致するか、または本番サーバーで直接生成した値で上書きする。
- **（参考）AI/サブスク/管理画面の本番動作はほぼ完成**
  - 管理者認証部分のみが最後の壁。

### 3. 明日以降の推奨アクション
- [ ] 本番サーバー上でbcryptjsによるハッシュ生成・検証APIを一時的に用意し、admin123でログインできるか検証
- [ ] Supabaseのadmin_usersテーブルのハッシュ値を本番Node.js環境で再生成・上書き
- [ ] 管理者セッションのJWTトークン発行・検証を本番用に切り替え
- [ ] 上記で解決しない場合は、APIのユーザー取得ロジックや環境変数の再確認 